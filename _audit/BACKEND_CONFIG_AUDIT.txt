### 1) SecurityConfig (CORS etc.) ###
package com.atelie.ecommerce.infrastructure.config.security;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web.configurers.AbstractHttpConfigurer;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.web.cors.CorsConfiguration;
import org.springframework.web.cors.UrlBasedCorsConfigurationSource;
import org.springframework.web.filter.CorsFilter;

import java.util.List;

@Configuration
@EnableWebSecurity
public class SecurityConfig {

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            // Desativa CSRF (Desnecessário para API REST Stateless)
            // Isso resolve o erro 403 no Upload/POST
            .csrf(AbstractHttpConfigurer::disable)
            
            // Habilita CORS (Permite o Frontend falar com o Backend)
            .cors(cors -> cors.configurationSource(corsConfigurationSource()))
            
            // Regras de Acesso
            .authorizeHttpRequests(auth -> auth
                // Permite acesso público a endpoints de Auth e arquivos (para visualização)
                .requestMatchers("/api/auth/**").permitAll()
                .requestMatchers("/api/files/view/**").permitAll() 
                .requestMatchers("/api/health").permitAll()
                // Uploads e outros endpoints exigem autenticação (futuramente)
                // Por enquanto, para DESBLOQUEAR seu desenvolvimento, vamos permitir tudo
                // Depois fechamos quando o JWT estiver implementado 100%
                .anyRequest().permitAll() 
            );

        return http.build();
    }

    @Bean
    public UrlBasedCorsConfigurationSource corsConfigurationSource() {
        CorsConfiguration config = new CorsConfiguration();
        config.setAllowCredentials(true);
        // Permite o Frontend (ajuste a porta se necessário, ex: 5173 ou 3000)
        config.addAllowedOrigin("http://localhost:3000"); 
        config.addAllowedOrigin("http://localhost:5173");
        config.addAllowedHeader("*");
        config.addAllowedMethod("*");

        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
        source.registerCorsConfiguration("/**", config);
        return source;
    }
}

### 2) MercadoLivreService ###
package com.atelie.ecommerce.application.integration.mercadolivre;

import com.atelie.ecommerce.api.config.DynamicConfigService;
import com.atelie.ecommerce.api.order.dto.CreateOrderItemRequest;
import com.atelie.ecommerce.api.order.dto.CreateOrderRequest;
import com.atelie.ecommerce.application.integration.MarketplaceIntegrationService;
import com.atelie.ecommerce.infrastructure.persistence.product.entity.ProductEntity;
import com.atelie.ecommerce.infrastructure.persistence.product.ProductIntegrationEntity;
import com.atelie.ecommerce.infrastructure.persistence.product.ProductIntegrationRepository;
import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import lombok.extern.slf4j.Slf4j;
import org.springframework.http.*;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.client.RestTemplate;

import java.math.BigDecimal;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

@Slf4j
@Service
public class MercadoLivreService implements MarketplaceIntegrationService {

    private final ProductIntegrationRepository integrationRepository;
    private final DynamicConfigService configService;
    private final RestTemplate restTemplate;
    private final ObjectMapper objectMapper = new ObjectMapper();

    public MercadoLivreService(ProductIntegrationRepository integrationRepository,
                               DynamicConfigService configService,
                               RestTemplate restTemplate) {
        this.integrationRepository = integrationRepository;
        this.configService = configService;
        this.restTemplate = restTemplate;
    }

    // --- Lógica INBOUND (Trazer Pedidos) ---
    @Override
    @Transactional(readOnly = true)
    public CreateOrderRequest fetchAndConvertOrder(String resourceId) {
        if (!configService.containsKey("ML_SYNC_ENABLED") || !configService.requireBoolean("ML_SYNC_ENABLED")) {
             // Silently ignore or throw depending on trigger
             return null; 
        }

        String token = configService.requireString("ML_ACCESS_TOKEN");
        String url = "https://api.mercadolibre.com/orders/" + resourceId;

        try {
            HttpHeaders headers = new HttpHeaders();
            headers.setBearerAuth(token);
            HttpEntity<String> entity = new HttpEntity<>(headers);

            ResponseEntity<JsonNode> response = restTemplate.exchange(url, HttpMethod.GET, entity, JsonNode.class);
            JsonNode orderJson = response.getBody();

            if (orderJson == null) throw new RuntimeException("Empty response from ML");

            JsonNode orderItems = orderJson.path("order_items");
            if (orderItems.isEmpty()) throw new IllegalStateException("ML Order without items: " + resourceId);

            JsonNode firstItem = orderItems.get(0);
            String mlItemId = firstItem.path("item").path("id").asText();
            int quantity = firstItem.path("quantity").asInt(1);

            // Busca produto local vinculado
            var integration = integrationRepository.findByExternalIdAndIntegrationType(mlItemId, "MERCADO_LIVRE")
                    .orElseThrow(() -> new IllegalArgumentException("Produto não vinculado para item ML: " + mlItemId));

            String customerName = orderJson.path("buyer").path("nickname").asText("Desconhecido");

            return new CreateOrderRequest(
                "MERCADO_LIVRE",
                resourceId,
                customerName,
                List.of(new CreateOrderItemRequest(integration.getProduct().getId(), null, quantity))
            );

        } catch (Exception e) {
            log.error("Erro integration fetch ML", e);
            throw new RuntimeException("Erro ML Fetch", e);
        }
    }

    // --- Lógica OUTBOUND (Publicar/Atualizar Anúncio Real) ---
    public void createListing(ProductEntity product) {
        // 1. Guard Clause: Config via Dashboard
        if (!configService.containsKey("ML_SYNC_ENABLED") || !configService.requireBoolean("ML_SYNC_ENABLED")) {
            log.info("Sync Mercado Livre desativado no Dashboard. Ignorando produto: {}", product.getName());
            return;
        }

        String token = configService.requireString("ML_ACCESS_TOKEN");
        String url = "https://api.mercadolibre.com/items";

        // 2. Monta Payload Real do ML
        Map<String, Object> payload = new HashMap<>();
        payload.put("title", product.getName());
        payload.put("category_id", "MLB3530"); // Exemplo: Categoria Genérica (Dashboard poderia mapear isso)
        payload.put("price", product.getPrice());
        payload.put("currency_id", "BRL");
        payload.put("available_quantity", product.getStockQuantity());
        payload.put("buying_mode", "buy_it_now");
        payload.put("condition", "new");
        payload.put("listing_type_id", "gold_special");
        
        // Imagens (Se tiver URL pública)
        if (product.getImageUrl() != null && product.getImageUrl().startsWith("http")) {
            payload.put("pictures", List.of(Map.of("source", product.getImageUrl())));
        }

        try {
            HttpHeaders headers = new HttpHeaders();
            headers.setContentType(MediaType.APPLICATION_JSON);
            headers.setBearerAuth(token);

            HttpEntity<Map<String, Object>> entity = new HttpEntity<>(payload, headers);
            
            // 3. POST Real
            ResponseEntity<JsonNode> response = restTemplate.postForEntity(url, entity, JsonNode.class);
            
            if (response.getStatusCode().is2xxSuccessful() && response.getBody() != null) {
                String mlId = response.getBody().get("id").asText();
                String permalink = response.getBody().get("permalink").asText();
                
                log.info("Anúncio criado no ML com sucesso! ID: {}, Link: {}", mlId, permalink);

                // 4. Salva o vínculo no banco para futuras atualizações de estoque
                saveIntegrationLink(product, mlId);
            }

        } catch (Exception e) {
            log.error("Falha ao criar anúncio no ML. Verifique Token/Permissões.", e);
            // Não relança erro para não abortar a transação do produto local
        }
    }

    private void saveIntegrationLink(ProductEntity product, String externalId) {
        // Verifica se já existe para evitar duplicação
        if (integrationRepository.findByExternalIdAndIntegrationType(externalId, "MERCADO_LIVRE").isEmpty()) {
            ProductIntegrationEntity link = new ProductIntegrationEntity(
                product, "MERCADO_LIVRE", externalId, null
            );
            integrationRepository.save(link);
        }
    }
}

### 3) MercadoPagoPaymentDriver ###
package com.atelie.ecommerce.api.serviceengine.driver.payment;

import com.atelie.ecommerce.api.serviceengine.ServiceDriver;
import com.atelie.ecommerce.api.serviceengine.util.DriverConfigReader;
import com.atelie.ecommerce.domain.service.model.ServiceType;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpHeaders;
import org.springframework.http.MediaType;
import org.springframework.stereotype.Component;
import org.springframework.web.client.RestTemplate;

import java.math.BigDecimal;
import java.util.HashMap;
import java.util.Map;
import java.util.UUID;

@Component
public class MercadoPagoPaymentDriver implements ServiceDriver {

    private final RestTemplate restTemplate;

    public MercadoPagoPaymentDriver(RestTemplate restTemplate) {
        this.restTemplate = restTemplate;
    }

    @Override
    public String driverKey() { return "payment.mercadopago"; }

    @Override
    public ServiceType serviceType() { return ServiceType.PAYMENT; }

    @Override
    public Map<String, Object> execute(Map<String, Object> request, Map<String, Object> config) {
        // 1. Ler credenciais do JSON de Configuração (Vindo do Banco/Dashboard)
        String accessToken = DriverConfigReader.requireNonBlank(
            (String) config.get("access_token"), "access_token (Config MP)"
        );
        
        // Permite configurar endpoint de notificação dinâmico no Dashboard
        String notificationUrl = (String) config.get("notification_url"); 

        // 2. Dados do Pedido
        BigDecimal amount = (BigDecimal) request.get("amount");
        String email = (String) request.get("email");
        String externalRef = (String) request.get("orderId");

        // 3. Montar Payload para API do Mercado Pago
        Map<String, Object> mpRequest = new HashMap<>();
        mpRequest.put("transaction_amount", amount);
        mpRequest.put("description", "Pedido " + externalRef);
        mpRequest.put("payment_method_id", "pix");
        
        Map<String, Object> payer = new HashMap<>();
        payer.put("email", email);
        mpRequest.put("payer", payer);

        if (notificationUrl != null && !notificationUrl.isBlank()) {
            mpRequest.put("notification_url", notificationUrl);
        }

        // 4. Chamada Real
        try {
            HttpHeaders headers = new HttpHeaders();
            headers.setContentType(MediaType.APPLICATION_JSON);
            headers.setBearerAuth(accessToken);
            headers.set("X-Idempotency-Key", UUID.randomUUID().toString());

            HttpEntity<Map<String, Object>> entity = new HttpEntity<>(mpRequest, headers);
            
            // URL também pode vir da config se quiser suportar V1 ou V2
            String apiUrl = "https://api.mercadopago.com/v1/payments";
            
            Map response = restTemplate.postForObject(apiUrl, entity, Map.class);
            
            // 5. Retorno Padronizado
            Map<String, Object> result = new HashMap<>();
            result.put("provider", "MERCADO_PAGO");
            result.put("status", "pending"); // Pix começa pendente
            
            if (response != null) {
                result.put("external_id", response.get("id"));
                
                // Pega o QR Code (Copia e Cola)
                Map poi = (Map) response.get("point_of_interaction");
                if (poi != null) {
                    Map transData = (Map) poi.get("transaction_data");
                    if (transData != null) {
                        result.put("qr_code", transData.get("qr_code"));
                        result.put("qr_code_base64", transData.get("qr_code_base64"));
                    }
                }
            }
            return result;

        } catch (Exception e) {
            return Map.of("error", true, "message", "Erro MP: " + e.getMessage());
        }
    }
}

### 4) Seeds/Migrations (system_configs e configs seedadas) ###
total 24
drwxrwxr-x 2 imdias imdias 4096 jan 30 19:28 .
drwxrwxr-x 3 imdias imdias 4096 jan 30 19:28 ..
-rw-rw-r-- 1 imdias imdias 4566 jan 29 18:20 V1__init_schema.sql
-rw-rw-r-- 1 imdias imdias 1978 jan 29 18:20 V2__init_service_engine.sql
-rw-rw-r-- 1 imdias imdias 3056 jan 30 19:49 V3__seed_data.sql

-- ATENÇÃO: Usuário Admin agora é gerenciado pelo AdminBootstrap.java via variáveis de ambiente.

-- 1. System Configs Básicas
INSERT INTO system_config (config_key, config_value) VALUES
('CACHE_TTL_SECONDS', '300'),
('SHIPPING_PROVIDER_MODE', 'J3'),
('J3_RATE', '13.00'),
('J3_FREE_SHIPPING_THRESHOLD', '299.00'),
('J3_CEP_PREFIXES', ''),
('FLAT_RATE', '25.00'),
('FLAT_FREE_SHIPPING_THRESHOLD', '500.00'),
('N8N_WEBHOOK_URL', 'http://localhost:5678/webhook/test'),
('N8N_Automation_Enabled', 'false'),
('AI_ENABLED', 'false'),
('AI_API_URL', 'https://api.openai.com/v1/chat/completions'),
('AI_MODEL', 'gpt-4o-mini'),
('AI_PROMPT_TEMPLATE_DESC', 'Crie uma descrição para o produto {product} com contexto: {context}'),
('FISCAL_WEBHOOK_URL', ''),
('ML_SYNC_ENABLED', 'false')
ON CONFLICT (config_key) DO NOTHING;

-- 2. Providers (Drivers)
INSERT INTO service_providers (id, service_type, code, name, enabled, priority, driver_key, health_enabled) VALUES
(gen_random_uuid(), 'SHIPPING', 'J3', 'J3 Transportadora', true, 10, 'shipping.j3', true),
(gen_random_uuid(), 'SHIPPING', 'FLAT', 'Frete Fixo', true, 90, 'shipping.flat_rate', false),
(gen_random_uuid(), 'SHIPPING', 'LOGGI_WEBHOOK', 'Loggi API', false, 20, 'universal.shipping.webhook', true),
(gen_random_uuid(), 'PAYMENT', 'MERCADO_PAGO', 'Mercado Pago', true, 10, 'payment.mercadopago', true),
(gen_random_uuid(), 'PAYMENT', 'PIX_BANK_WEBHOOK', 'Banco Pix', false, 20, 'universal.payment.webhook', false),
(gen_random_uuid(), 'NOTIFICATION', 'WHATSAPP', 'WhatsApp', false, 10, 'universal.notification.webhook', false)
ON CONFLICT (service_type, code) DO NOTHING;

-- 3. Provider Configs (JSONs)
-- J3
INSERT INTO service_provider_configs (id, provider_id, environment, config_json)
SELECT gen_random_uuid(), id, 'prod', '{ "rate": 14.50, "free_threshold": 299.00, "cep_prefixes": "010,011,012,200,220" }'
FROM service_providers WHERE code = 'J3' AND service_type = 'SHIPPING';

-- Mercado Pago
INSERT INTO service_provider_configs (id, provider_id, environment, config_json)
SELECT gen_random_uuid(), id, 'prod', '{ "public_key": "APP_USR-...", "access_token": "APP_USR-...", "sandbox": false }'
FROM service_providers WHERE code = 'MERCADO_PAGO' AND service_type = 'PAYMENT';

-- 4. Regras de Roteamento Padrão
INSERT INTO service_routing_rules (id, service_type, enabled, priority, match_json, provider_code, behavior_json) VALUES 
-- Regra 1: Frete Grátis J3 acima de 500
(gen_random_uuid(), 'SHIPPING', true, 10, '{ "expression": "#ctx.cartTotal >= 500" }', 'J3', '{ "timeout_ms": 2000 }'),
-- Regra 2: Default Frete Fixo
(gen_random_uuid(), 'SHIPPING', true, 999, '{ "expression": "true" }', 'FLAT', NULL),
-- Regra 3: Default Pagamento MP
(gen_random_uuid(), 'PAYMENT', true, 100, '{ "expression": "true" }', 'MERCADO_PAGO', NULL);

-- 5. Feature Flag inicial
INSERT INTO feature_flags (id, flag_key, enabled, value_json, updated_at) VALUES 
(gen_random_uuid(), 'MAINTENANCE_MODE', false, '{"reason": "Upgrade de sistema", "eta": "2h"}', NOW())
ON CONFLICT (flag_key) DO NOTHING;

### 5) Onde system_configs é lido/escrito? (grep cirúrgico) ###

backend/src/main/java/com/atelie/ecommerce/application/service/fiscal/InvoiceService.java:3:import com.atelie.ecommerce.api.config.DynamicConfigService;
backend/src/main/java/com/atelie/ecommerce/application/service/fiscal/InvoiceService.java:14:    private final DynamicConfigService configService;
backend/src/main/java/com/atelie/ecommerce/application/service/fiscal/InvoiceService.java:17:    public InvoiceService(DynamicConfigService configService, RestTemplate restTemplate) {
backend/src/main/java/com/atelie/ecommerce/application/service/ai/AiContentService.java:3:import com.atelie.ecommerce.api.config.DynamicConfigService;
backend/src/main/java/com/atelie/ecommerce/application/service/ai/AiContentService.java:23:    private final DynamicConfigService configService;
backend/src/main/java/com/atelie/ecommerce/application/service/ai/AiContentService.java:29:    public AiContentService(DynamicConfigService configService, RestTemplate restTemplate) {
backend/src/main/java/com/atelie/ecommerce/application/service/ai/AiContentService.java:44:        if (apiUrl == null || apiKey == null) return "Erro de Configuração de IA";
backend/src/main/java/com/atelie/ecommerce/application/service/ai/AiContentService.java:73:        // 1. Verificação de Configuração
backend/src/main/java/com/atelie/ecommerce/application/service/integration/N8nService.java:3:import com.atelie.ecommerce.api.config.DynamicConfigService;
backend/src/main/java/com/atelie/ecommerce/application/service/integration/N8nService.java:15:    private final DynamicConfigService configService;
backend/src/main/java/com/atelie/ecommerce/application/service/integration/N8nService.java:20:    public N8nService(RestTemplate restTemplate, DynamicConfigService configService) {
backend/src/main/java/com/atelie/ecommerce/application/integration/mercadolivre/MercadoLivreService.java:3:import com.atelie.ecommerce.api.config.DynamicConfigService;
backend/src/main/java/com/atelie/ecommerce/application/integration/mercadolivre/MercadoLivreService.java:28:    private final DynamicConfigService configService;
backend/src/main/java/com/atelie/ecommerce/application/integration/mercadolivre/MercadoLivreService.java:33:                               DynamicConfigService configService,
backend/src/main/java/com/atelie/ecommerce/application/integration/mercadolivre/MercadoLivreService.java:90:        // 1. Guard Clause: Config via Dashboard
backend/src/main/java/com/atelie/ecommerce/infrastructure/persistence/service/model/ServiceProviderConfigEntity.java:13:public class ServiceProviderConfigEntity {
backend/src/main/java/com/atelie/ecommerce/infrastructure/persistence/service/model/ServiceProviderConfigEntity.java:52:    public String getConfigJson() { return configJson; }
backend/src/main/java/com/atelie/ecommerce/infrastructure/persistence/service/model/ServiceProviderConfigEntity.java:53:    public void setConfigJson(String configJson) { this.configJson = configJson; }
backend/src/main/java/com/atelie/ecommerce/infrastructure/persistence/service/jpa/ServiceProviderConfigJpaRepository.java:3:import com.atelie.ecommerce.infrastructure.persistence.service.model.ServiceProviderConfigEntity;
backend/src/main/java/com/atelie/ecommerce/infrastructure/persistence/service/jpa/ServiceProviderConfigJpaRepository.java:9:public interface ServiceProviderConfigJpaRepository extends JpaRepository<ServiceProviderConfigEntity, UUID> {
backend/src/main/java/com/atelie/ecommerce/infrastructure/persistence/service/jpa/ServiceProviderConfigJpaRepository.java:10:    Optional<ServiceProviderConfigEntity> findTopByProviderIdAndEnvironmentOrderByVersionDesc(UUID providerId, String environment);
backend/src/main/java/com/atelie/ecommerce/infrastructure/persistence/config/SystemConfigRepository.java:7:public interface SystemConfigRepository extends JpaRepository<SystemConfigEntity, String> {
backend/src/main/java/com/atelie/ecommerce/infrastructure/persistence/config/JpaSystemConfigGateway.java:3:import com.atelie.ecommerce.domain.config.SystemConfig;
backend/src/main/java/com/atelie/ecommerce/infrastructure/persistence/config/JpaSystemConfigGateway.java:4:import com.atelie.ecommerce.domain.config.SystemConfigGateway;
backend/src/main/java/com/atelie/ecommerce/infrastructure/persistence/config/JpaSystemConfigGateway.java:10: * JpaSystemConfigGateway.
backend/src/main/java/com/atelie/ecommerce/infrastructure/persistence/config/JpaSystemConfigGateway.java:13: * através do SystemConfigGateway.
backend/src/main/java/com/atelie/ecommerce/infrastructure/persistence/config/JpaSystemConfigGateway.java:16:public class JpaSystemConfigGateway implements SystemConfigGateway {
backend/src/main/java/com/atelie/ecommerce/infrastructure/persistence/config/JpaSystemConfigGateway.java:18:    private final SystemConfigRepository repository;
backend/src/main/java/com/atelie/ecommerce/infrastructure/persistence/config/JpaSystemConfigGateway.java:20:    public JpaSystemConfigGateway(SystemConfigRepository repository) {
backend/src/main/java/com/atelie/ecommerce/infrastructure/persistence/config/JpaSystemConfigGateway.java:25:    public List<SystemConfig> findAll() {
backend/src/main/java/com/atelie/ecommerce/infrastructure/persistence/config/JpaSystemConfigGateway.java:27:                .filter(e -> e.getConfigKey() != null)
backend/src/main/java/com/atelie/ecommerce/infrastructure/persistence/config/JpaSystemConfigGateway.java:28:                .map(e -> new SystemConfig(e.getConfigKey(), e.getConfigValue()))
backend/src/main/java/com/atelie/ecommerce/infrastructure/persistence/config/SystemConfigEntity.java:12:public class SystemConfigEntity {
backend/src/main/java/com/atelie/ecommerce/infrastructure/service/JpaServiceRoutingRuleGateway.java:3:import com.atelie.ecommerce.api.config.DynamicConfigService;
backend/src/main/java/com/atelie/ecommerce/infrastructure/service/JpaServiceRoutingRuleGateway.java:26:    private final DynamicConfigService dynamicConfigService;
backend/src/main/java/com/atelie/ecommerce/infrastructure/service/JpaServiceRoutingRuleGateway.java:32:    public JpaServiceRoutingRuleGateway(ServiceRoutingRuleJpaRepository repo, DynamicConfigService dynamicConfigService, Clock clock) {
backend/src/main/java/com/atelie/ecommerce/infrastructure/service/JpaServiceRoutingRuleGateway.java:34:        this.dynamicConfigService = dynamicConfigService;
backend/src/main/java/com/atelie/ecommerce/infrastructure/service/JpaServiceRoutingRuleGateway.java:39:        return dynamicConfigService.getLong(DynamicConfigService.CACHE_TTL_SECONDS_KEY, 300);
backend/src/main/java/com/atelie/ecommerce/infrastructure/service/ServiceEngineConfig.java:9:import com.atelie.ecommerce.domain.service.port.ServiceProviderConfigGateway;
backend/src/main/java/com/atelie/ecommerce/infrastructure/service/ServiceEngineConfig.java:13:import org.springframework.context.annotation.Configuration;
backend/src/main/java/com/atelie/ecommerce/infrastructure/service/ServiceEngineConfig.java:17:@Configuration
backend/src/main/java/com/atelie/ecommerce/infrastructure/service/ServiceEngineConfig.java:18:public class ServiceEngineConfig {
backend/src/main/java/com/atelie/ecommerce/infrastructure/service/ServiceEngineConfig.java:42:            ServiceProviderConfigGateway configGateway,
backend/src/main/java/com/atelie/ecommerce/infrastructure/service/JpaServiceProviderConfigGateway.java:3:import com.atelie.ecommerce.api.config.DynamicConfigService;
backend/src/main/java/com/atelie/ecommerce/infrastructure/service/JpaServiceProviderConfigGateway.java:4:import com.atelie.ecommerce.domain.service.port.ServiceProviderConfigGateway;
backend/src/main/java/com/atelie/ecommerce/infrastructure/service/JpaServiceProviderConfigGateway.java:5:import com.atelie.ecommerce.infrastructure.persistence.service.jpa.ServiceProviderConfigJpaRepository;
backend/src/main/java/com/atelie/ecommerce/infrastructure/service/JpaServiceProviderConfigGateway.java:19:public class JpaServiceProviderConfigGateway implements ServiceProviderConfigGateway {
backend/src/main/java/com/atelie/ecommerce/infrastructure/service/JpaServiceProviderConfigGateway.java:21:    private static final Logger log = LoggerFactory.getLogger(JpaServiceProviderConfigGateway.class);
backend/src/main/java/com/atelie/ecommerce/infrastructure/service/JpaServiceProviderConfigGateway.java:24:    private final ServiceProviderConfigJpaRepository configRepo;
backend/src/main/java/com/atelie/ecommerce/infrastructure/service/JpaServiceProviderConfigGateway.java:25:    private final DynamicConfigService dynamicConfigService;
backend/src/main/java/com/atelie/ecommerce/infrastructure/service/JpaServiceProviderConfigGateway.java:31:    public JpaServiceProviderConfigGateway(
backend/src/main/java/com/atelie/ecommerce/infrastructure/service/JpaServiceProviderConfigGateway.java:33:            ServiceProviderConfigJpaRepository configRepo,
backend/src/main/java/com/atelie/ecommerce/infrastructure/service/JpaServiceProviderConfigGateway.java:34:            DynamicConfigService dynamicConfigService,
backend/src/main/java/com/atelie/ecommerce/infrastructure/service/JpaServiceProviderConfigGateway.java:39:        this.dynamicConfigService = dynamicConfigService;
backend/src/main/java/com/atelie/ecommerce/infrastructure/service/JpaServiceProviderConfigGateway.java:44:        return dynamicConfigService.getLong(DynamicConfigService.CACHE_TTL_SECONDS_KEY, 300);
backend/src/main/java/com/atelie/ecommerce/infrastructure/service/JpaServiceProviderConfigGateway.java:55:    public Optional<String> findConfigJson(String providerCode, String environment) {
backend/src/main/java/com/atelie/ecommerce/infrastructure/service/JpaServiceProviderConfigGateway.java:66:                .map(c -> c.getConfigJson());
backend/src/main/java/com/atelie/ecommerce/infrastructure/service/JpaServiceProviderConfigGateway.java:77:        log.info("ServiceProviderConfig cache cleared.");
backend/src/main/java/com/atelie/ecommerce/infrastructure/service/JpaServiceProviderGateway.java:3:import com.atelie.ecommerce.api.config.DynamicConfigService;
backend/src/main/java/com/atelie/ecommerce/infrastructure/service/JpaServiceProviderGateway.java:25:    private final DynamicConfigService dynamicConfigService;
backend/src/main/java/com/atelie/ecommerce/infrastructure/service/JpaServiceProviderGateway.java:34:            DynamicConfigService dynamicConfigService,
backend/src/main/java/com/atelie/ecommerce/infrastructure/service/JpaServiceProviderGateway.java:38:        this.dynamicConfigService = dynamicConfigService;
backend/src/main/java/com/atelie/ecommerce/infrastructure/service/JpaServiceProviderGateway.java:43:        return dynamicConfigService.getLong(DynamicConfigService.CACHE_TTL_SECONDS_KEY, 300);
backend/src/main/java/com/atelie/ecommerce/infrastructure/config/ClockConfig.java:4:import org.springframework.context.annotation.Configuration;
backend/src/main/java/com/atelie/ecommerce/infrastructure/config/ClockConfig.java:8:@Configuration
backend/src/main/java/com/atelie/ecommerce/infrastructure/config/ClockConfig.java:9:public class ClockConfig {
backend/src/main/java/com/atelie/ecommerce/infrastructure/config/OpenApiConfig.java:6:import org.springframework.context.annotation.Configuration;
backend/src/main/java/com/atelie/ecommerce/infrastructure/config/OpenApiConfig.java:8:@Configuration
backend/src/main/java/com/atelie/ecommerce/infrastructure/config/OpenApiConfig.java:9:public class OpenApiConfig {
backend/src/main/java/com/atelie/ecommerce/infrastructure/config/security/SecurityConfig.java:4:import org.springframework.context.annotation.Configuration;
backend/src/main/java/com/atelie/ecommerce/infrastructure/config/security/SecurityConfig.java:7:import org.springframework.security.config.annotation.web.configurers.AbstractHttpConfigurer;
backend/src/main/java/com/atelie/ecommerce/infrastructure/config/security/SecurityConfig.java:9:import org.springframework.web.cors.CorsConfiguration;
backend/src/main/java/com/atelie/ecommerce/infrastructure/config/security/SecurityConfig.java:10:import org.springframework.web.cors.UrlBasedCorsConfigurationSource;
backend/src/main/java/com/atelie/ecommerce/infrastructure/config/security/SecurityConfig.java:15:@Configuration
backend/src/main/java/com/atelie/ecommerce/infrastructure/config/security/SecurityConfig.java:17:public class SecurityConfig {
backend/src/main/java/com/atelie/ecommerce/infrastructure/config/security/SecurityConfig.java:24:            .csrf(AbstractHttpConfigurer::disable)
backend/src/main/java/com/atelie/ecommerce/infrastructure/config/security/SecurityConfig.java:27:            .cors(cors -> cors.configurationSource(corsConfigurationSource()))
backend/src/main/java/com/atelie/ecommerce/infrastructure/config/security/SecurityConfig.java:45:    public UrlBasedCorsConfigurationSource corsConfigurationSource() {
backend/src/main/java/com/atelie/ecommerce/infrastructure/config/security/SecurityConfig.java:46:        CorsConfiguration config = new CorsConfiguration();
backend/src/main/java/com/atelie/ecommerce/infrastructure/config/security/SecurityConfig.java:54:        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
backend/src/main/java/com/atelie/ecommerce/infrastructure/config/security/SecurityConfig.java:55:        source.registerCorsConfiguration("/**", config);
backend/src/main/java/com/atelie/ecommerce/infrastructure/config/AsyncConfig.java:3:import org.springframework.context.annotation.Configuration;
backend/src/main/java/com/atelie/ecommerce/infrastructure/config/AsyncConfig.java:6:@Configuration
backend/src/main/java/com/atelie/ecommerce/infrastructure/config/AsyncConfig.java:8:public class AsyncConfig {
backend/src/main/java/com/atelie/ecommerce/infrastructure/http/RestTemplateConfig.java:5:import org.springframework.context.annotation.Configuration;
backend/src/main/java/com/atelie/ecommerce/infrastructure/http/RestTemplateConfig.java:9:@Configuration
backend/src/main/java/com/atelie/ecommerce/infrastructure/http/RestTemplateConfig.java:10:public class RestTemplateConfig {
backend/src/main/java/com/atelie/ecommerce/infrastructure/security/PasswordConfig.java:4:import org.springframework.context.annotation.Configuration;
backend/src/main/java/com/atelie/ecommerce/infrastructure/security/PasswordConfig.java:8:@Configuration
backend/src/main/java/com/atelie/ecommerce/infrastructure/security/PasswordConfig.java:9:public class PasswordConfig {
backend/src/main/java/com/atelie/ecommerce/infrastructure/security/AuthenticationConfig.java:4:import org.springframework.context.annotation.Configuration;
backend/src/main/java/com/atelie/ecommerce/infrastructure/security/AuthenticationConfig.java:8:import org.springframework.security.config.annotation.authentication.configuration.AuthenticationConfiguration;
backend/src/main/java/com/atelie/ecommerce/infrastructure/security/AuthenticationConfig.java:12:@Configuration
backend/src/main/java/com/atelie/ecommerce/infrastructure/security/AuthenticationConfig.java:13:public class AuthenticationConfig {
backend/src/main/java/com/atelie/ecommerce/infrastructure/security/AuthenticationConfig.java:27:    public AuthenticationManager authenticationManager(AuthenticationConfiguration config) throws Exception {
backend/src/main/java/com/atelie/ecommerce/domain/service/port/ServiceProviderConfigGateway.java:5:public interface ServiceProviderConfigGateway {
backend/src/main/java/com/atelie/ecommerce/domain/service/port/ServiceProviderConfigGateway.java:6:    Optional<String> findConfigJson(String providerCode, String environment);
backend/src/main/java/com/atelie/ecommerce/domain/config/SystemConfigKey.java:3:public enum SystemConfigKey {
backend/src/main/java/com/atelie/ecommerce/domain/config/SystemConfigGateway.java:5:public interface SystemConfigGateway {
backend/src/main/java/com/atelie/ecommerce/domain/config/SystemConfigGateway.java:7:    List<SystemConfig> findAll();
backend/src/main/java/com/atelie/ecommerce/domain/config/SystemConfig.java:3:public class SystemConfig {
backend/src/main/java/com/atelie/ecommerce/domain/config/SystemConfig.java:8:    public SystemConfig(String key, String value) {
backend/src/main/java/com/atelie/ecommerce/api/serviceengine/driver/shipping/J3ShippingDriver.java:4:import com.atelie.ecommerce.api.serviceengine.util.DriverConfigReader;
backend/src/main/java/com/atelie/ecommerce/api/serviceengine/driver/shipping/J3ShippingDriver.java:24:        String cep = DriverConfigReader.requireNonBlank((String) request.get("cep"), "cep");
backend/src/main/java/com/atelie/ecommerce/api/serviceengine/driver/shipping/J3ShippingDriver.java:25:        BigDecimal subtotal = DriverConfigReader.requireMoney(request.get("subtotal"), "subtotal");
backend/src/main/java/com/atelie/ecommerce/api/serviceengine/driver/shipping/J3ShippingDriver.java:28:        BigDecimal rate = DriverConfigReader.requireBigDecimal(config, "rate");
backend/src/main/java/com/atelie/ecommerce/api/serviceengine/driver/shipping/J3ShippingDriver.java:29:        BigDecimal threshold = DriverConfigReader.requireBigDecimal(config, "free_threshold");
backend/src/main/java/com/atelie/ecommerce/api/serviceengine/driver/shipping/J3ShippingDriver.java:30:        String prefixes = DriverConfigReader.optionalString(config, "cep_prefixes", "");
backend/src/main/java/com/atelie/ecommerce/api/serviceengine/driver/shipping/FlatRateShippingDriver.java:4:import com.atelie.ecommerce.api.serviceengine.util.DriverConfigReader;
backend/src/main/java/com/atelie/ecommerce/api/serviceengine/driver/shipping/FlatRateShippingDriver.java:23:        BigDecimal subtotal = DriverConfigReader.requireMoney(request.get("subtotal"), "subtotal");
backend/src/main/java/com/atelie/ecommerce/api/serviceengine/driver/shipping/FlatRateShippingDriver.java:26:        BigDecimal rate = DriverConfigReader.requireBigDecimal(config, "rate");
backend/src/main/java/com/atelie/ecommerce/api/serviceengine/driver/shipping/FlatRateShippingDriver.java:27:        BigDecimal threshold = DriverConfigReader.requireBigDecimal(config, "free_threshold");
backend/src/main/java/com/atelie/ecommerce/api/serviceengine/driver/payment/MercadoPagoPaymentDriver.java:4:import com.atelie.ecommerce.api.serviceengine.util.DriverConfigReader;
backend/src/main/java/com/atelie/ecommerce/api/serviceengine/driver/payment/MercadoPagoPaymentDriver.java:34:        // 1. Ler credenciais do JSON de Configuração (Vindo do Banco/Dashboard)
backend/src/main/java/com/atelie/ecommerce/api/serviceengine/driver/payment/MercadoPagoPaymentDriver.java:35:        String accessToken = DriverConfigReader.requireNonBlank(
backend/src/main/java/com/atelie/ecommerce/api/serviceengine/driver/payment/MercadoPagoPaymentDriver.java:36:            (String) config.get("access_token"), "access_token (Config MP)"
backend/src/main/java/com/atelie/ecommerce/api/serviceengine/util/DriverConfigReader.java:6:public final class DriverConfigReader {
backend/src/main/java/com/atelie/ecommerce/api/serviceengine/util/DriverConfigReader.java:8:    private DriverConfigReader() {}
backend/src/main/java/com/atelie/ecommerce/api/serviceengine/util/DriverConfigReader.java:13:            throw new IllegalArgumentException("Config obrigatória ausente: '" + key + "'");
backend/src/main/java/com/atelie/ecommerce/api/serviceengine/util/DriverConfigReader.java:18:            throw new IllegalArgumentException("Config inválida para '" + key + "': valor='" + v + "'");
backend/src/main/java/com/atelie/ecommerce/api/serviceengine/ServiceOrchestrator.java:7:import com.atelie.ecommerce.domain.service.port.ServiceProviderConfigGateway;
backend/src/main/java/com/atelie/ecommerce/api/serviceengine/ServiceOrchestrator.java:16:    private final ServiceProviderConfigGateway configGateway;
backend/src/main/java/com/atelie/ecommerce/api/serviceengine/ServiceOrchestrator.java:21:            ServiceProviderConfigGateway configGateway,
backend/src/main/java/com/atelie/ecommerce/api/serviceengine/ServiceOrchestrator.java:54:                .findConfigJson(provider.code(), environment)
backend/src/main/java/com/atelie/ecommerce/api/shipping/controller/ShippingController.java:3:import com.atelie.ecommerce.api.config.DynamicConfigService;
backend/src/main/java/com/atelie/ecommerce/api/shipping/controller/ShippingController.java:16:    private final DynamicConfigService dynamicConfigService;
backend/src/main/java/com/atelie/ecommerce/api/shipping/controller/ShippingController.java:18:    public ShippingController(ShippingService shippingService, DynamicConfigService dynamicConfigService) {
backend/src/main/java/com/atelie/ecommerce/api/shipping/controller/ShippingController.java:20:        this.dynamicConfigService = dynamicConfigService;
backend/src/main/java/com/atelie/ecommerce/api/shipping/controller/ShippingController.java:30:    public ResponseEntity<Void> refreshConfigs() {
backend/src/main/java/com/atelie/ecommerce/api/shipping/controller/ShippingController.java:31:        dynamicConfigService.refresh();
backend/src/main/java/com/atelie/ecommerce/api/config/ConfigBootstrap.java:8:public class ConfigBootstrap implements ApplicationRunner {
backend/src/main/java/com/atelie/ecommerce/api/config/ConfigBootstrap.java:10:    private final DynamicConfigService dynamicConfigService;
backend/src/main/java/com/atelie/ecommerce/api/config/ConfigBootstrap.java:12:    public ConfigBootstrap(DynamicConfigService dynamicConfigService) {
backend/src/main/java/com/atelie/ecommerce/api/config/ConfigBootstrap.java:13:        this.dynamicConfigService = dynamicConfigService;
backend/src/main/java/com/atelie/ecommerce/api/config/ConfigBootstrap.java:19:        dynamicConfigService.refresh();
backend/src/main/java/com/atelie/ecommerce/api/config/StaticResourceConfig.java:3:import org.springframework.context.annotation.Configuration;
backend/src/main/java/com/atelie/ecommerce/api/config/StaticResourceConfig.java:5:import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;
backend/src/main/java/com/atelie/ecommerce/api/config/StaticResourceConfig.java:10:@Configuration
backend/src/main/java/com/atelie/ecommerce/api/config/StaticResourceConfig.java:11:public class StaticResourceConfig implements WebMvcConfigurer {
backend/src/main/java/com/atelie/ecommerce/api/config/exception/MissingConfigException.java:3:public class MissingConfigException extends RuntimeException {
backend/src/main/java/com/atelie/ecommerce/api/config/exception/MissingConfigException.java:4:    public MissingConfigException(String key) {
backend/src/main/java/com/atelie/ecommerce/api/config/exception/MissingConfigException.java:5:        super("Config obrigatória ausente no banco: " + key);
backend/src/main/java/com/atelie/ecommerce/api/config/DynamicConfigService.java:3:import com.atelie.ecommerce.api.config.exception.MissingConfigException;
backend/src/main/java/com/atelie/ecommerce/api/config/DynamicConfigService.java:4:import com.atelie.ecommerce.domain.config.SystemConfig;
backend/src/main/java/com/atelie/ecommerce/api/config/DynamicConfigService.java:5:import com.atelie.ecommerce.domain.config.SystemConfigGateway;
backend/src/main/java/com/atelie/ecommerce/api/config/DynamicConfigService.java:17:public class DynamicConfigService {
backend/src/main/java/com/atelie/ecommerce/api/config/DynamicConfigService.java:19:    private static final Logger log = LoggerFactory.getLogger(DynamicConfigService.class);
backend/src/main/java/com/atelie/ecommerce/api/config/DynamicConfigService.java:23:    private final SystemConfigGateway gateway;
backend/src/main/java/com/atelie/ecommerce/api/config/DynamicConfigService.java:32:    public DynamicConfigService(SystemConfigGateway gateway, Clock clock) {
backend/src/main/java/com/atelie/ecommerce/api/config/DynamicConfigService.java:39:        log.info("DynamicConfigService: Recarregando configurações...");
backend/src/main/java/com/atelie/ecommerce/api/config/DynamicConfigService.java:41:        for (SystemConfig c : gateway.findAll()) {
backend/src/main/java/com/atelie/ecommerce/api/config/DynamicConfigService.java:47:        log.info("DynamicConfigService: cache atualizado. Total chaves={}", cache.size());
backend/src/main/java/com/atelie/ecommerce/api/config/DynamicConfigService.java:86:        if (value == null) throw new MissingConfigException(key);
backend/src/main/java/com/atelie/ecommerce/api/config/DynamicConfigService.java:93:        catch (Exception e) { throw new IllegalStateException("Config inválida (BigDecimal) para " + key); }
backend/src/main/java/com/atelie/ecommerce/api/config/DynamicConfigService.java:100:        catch (Exception e) { throw new IllegalStateException("Config inválida (long) para " + key); }
backend/src/main/java/com/atelie/ecommerce/api/config/DynamicConfigService.java:105:        if (v == null) throw new MissingConfigException(key);
backend/src/main/java/com/atelie/ecommerce/api/dashboard/DashboardController.java:7:import com.atelie.ecommerce.infrastructure.persistence.config.SystemConfigRepository;
backend/src/main/java/com/atelie/ecommerce/api/dashboard/DashboardController.java:8:import com.atelie.ecommerce.infrastructure.persistence.config.SystemConfigEntity;
backend/src/main/java/com/atelie/ecommerce/api/dashboard/DashboardController.java:9:import com.atelie.ecommerce.api.config.DynamicConfigService;
backend/src/main/java/com/atelie/ecommerce/api/dashboard/DashboardController.java:22:    private final SystemConfigRepository configRepository;
backend/src/main/java/com/atelie/ecommerce/api/dashboard/DashboardController.java:23:    private final DynamicConfigService dynamicConfigService;
backend/src/main/java/com/atelie/ecommerce/api/dashboard/DashboardController.java:28:                               SystemConfigRepository configRepository,
backend/src/main/java/com/atelie/ecommerce/api/dashboard/DashboardController.java:29:                               DynamicConfigService dynamicConfigService) {
backend/src/main/java/com/atelie/ecommerce/api/dashboard/DashboardController.java:34:        this.dynamicConfigService = dynamicConfigService;
backend/src/main/java/com/atelie/ecommerce/api/dashboard/DashboardController.java:58:        SystemConfigEntity config = new SystemConfigEntity();
backend/src/main/java/com/atelie/ecommerce/api/dashboard/DashboardController.java:59:        config.setConfigKey("N8N_Automation_Enabled");
backend/src/main/java/com/atelie/ecommerce/api/dashboard/DashboardController.java:60:        config.setConfigValue(String.valueOf(enable));
backend/src/main/java/com/atelie/ecommerce/api/dashboard/DashboardController.java:64:        dynamicConfigService.refresh();
backend/src/main/java/com/atelie/ecommerce/api/admin/AdminCacheController.java:3:import com.atelie.ecommerce.api.config.DynamicConfigService;
backend/src/main/java/com/atelie/ecommerce/api/admin/AdminCacheController.java:4:import com.atelie.ecommerce.domain.service.port.ServiceProviderConfigGateway;
backend/src/main/java/com/atelie/ecommerce/api/admin/AdminCacheController.java:16:    private final DynamicConfigService dynamicConfigService;
backend/src/main/java/com/atelie/ecommerce/api/admin/AdminCacheController.java:19:    private final ServiceProviderConfigGateway providerConfigGateway;
backend/src/main/java/com/atelie/ecommerce/api/admin/AdminCacheController.java:22:            DynamicConfigService dynamicConfigService,
backend/src/main/java/com/atelie/ecommerce/api/admin/AdminCacheController.java:25:            ServiceProviderConfigGateway providerConfigGateway
backend/src/main/java/com/atelie/ecommerce/api/admin/AdminCacheController.java:27:        this.dynamicConfigService = dynamicConfigService;
backend/src/main/java/com/atelie/ecommerce/api/admin/AdminCacheController.java:30:        this.providerConfigGateway = providerConfigGateway;
backend/src/main/java/com/atelie/ecommerce/api/admin/AdminCacheController.java:35:        dynamicConfigService.refresh();
backend/src/main/java/com/atelie/ecommerce/api/admin/AdminCacheController.java:38:        providerConfigGateway.refresh();
backend/src/main/java/com/atelie/ecommerce/api/admin/AdminConfigController.java:3:import com.atelie.ecommerce.api.config.DynamicConfigService;
backend/src/main/java/com/atelie/ecommerce/api/admin/AdminConfigController.java:4:import com.atelie.ecommerce.infrastructure.persistence.config.SystemConfigEntity;
backend/src/main/java/com/atelie/ecommerce/api/admin/AdminConfigController.java:5:import com.atelie.ecommerce.infrastructure.persistence.config.SystemConfigRepository;
backend/src/main/java/com/atelie/ecommerce/api/admin/AdminConfigController.java:13:public class AdminConfigController {
backend/src/main/java/com/atelie/ecommerce/api/admin/AdminConfigController.java:15:    private final SystemConfigRepository repository;
backend/src/main/java/com/atelie/ecommerce/api/admin/AdminConfigController.java:16:    private final DynamicConfigService configService;
backend/src/main/java/com/atelie/ecommerce/api/admin/AdminConfigController.java:18:    public AdminConfigController(SystemConfigRepository repository, DynamicConfigService configService) {
backend/src/main/java/com/atelie/ecommerce/api/admin/AdminConfigController.java:24:    public List<SystemConfigEntity> listAll() {
backend/src/main/java/com/atelie/ecommerce/api/admin/AdminConfigController.java:29:    public ResponseEntity<SystemConfigEntity> upsert(@RequestBody SystemConfigEntity dto) {
backend/src/main/java/com/atelie/ecommerce/api/admin/AdminConfigController.java:30:        SystemConfigEntity saved = repository.save(dto);
backend/src/main/java/com/atelie/ecommerce/api/admin/AdminProviderConfigController.java:3:import com.atelie.ecommerce.domain.service.port.ServiceProviderConfigGateway;
backend/src/main/java/com/atelie/ecommerce/api/admin/AdminProviderConfigController.java:4:import com.atelie.ecommerce.infrastructure.persistence.service.jpa.ServiceProviderConfigJpaRepository;
backend/src/main/java/com/atelie/ecommerce/api/admin/AdminProviderConfigController.java:5:import com.atelie.ecommerce.infrastructure.persistence.service.model.ServiceProviderConfigEntity;
backend/src/main/java/com/atelie/ecommerce/api/admin/AdminProviderConfigController.java:15:public class AdminProviderConfigController {
backend/src/main/java/com/atelie/ecommerce/api/admin/AdminProviderConfigController.java:17:    private final ServiceProviderConfigJpaRepository repository;
backend/src/main/java/com/atelie/ecommerce/api/admin/AdminProviderConfigController.java:18:    private final ServiceProviderConfigGateway gateway; // Injeta o gateway para limpar cache
backend/src/main/java/com/atelie/ecommerce/api/admin/AdminProviderConfigController.java:20:    public AdminProviderConfigController(ServiceProviderConfigJpaRepository repository,
backend/src/main/java/com/atelie/ecommerce/api/admin/AdminProviderConfigController.java:21:                                         ServiceProviderConfigGateway gateway) {
backend/src/main/java/com/atelie/ecommerce/api/admin/AdminProviderConfigController.java:27:    public ResponseEntity<ServiceProviderConfigEntity> get(@PathVariable UUID providerId, @PathVariable String env) {
backend/src/main/java/com/atelie/ecommerce/api/admin/AdminProviderConfigController.java:34:    public ResponseEntity<ServiceProviderConfigEntity> upsert(@RequestBody ServiceProviderConfigEntity config) {
backend/src/main/java/com/atelie/ecommerce/api/admin/AdminProviderConfigController.java:37:        Optional<ServiceProviderConfigEntity> current = repository
backend/src/main/java/com/atelie/ecommerce/api/admin/AdminProviderConfigController.java:43:        ServiceProviderConfigEntity saved = repository.save(config);

### 6) application.yml/properties (pra ver placeholders e defaults) ###
--- application.yml ---
spring:
  application:
    name: ecommerce-core

  datasource:
    url: ${DB_URL:jdbc:postgresql://localhost:5432/ecommerce}
    username: ${DB_USER:postgres}
    password: ${DB_PASS:postgres}
    # TUNING PARA PRODUÇÃO
    hikari:
      maximum-pool-size: ${DB_POOL_SIZE:20}
      minimum-idle: 5
      idle-timeout: 30000
      connection-timeout: 20000
      max-lifetime: 1800000

  jpa:
    hibernate:
      ddl-auto: validate
    properties:
      hibernate:
        format_sql: false # Desligar em produção para performance
    open-in-view: false   # Boas práticas: desativar OSIV para evitar conexões presas

  flyway:
    enabled: true
    locations: classpath:db/migration

# Suporte a Proxy Reverso (Nginx/AWS LB/Https)
server:
  port: ${PORT:8080}
  forward-headers-strategy: native

--- application.properties ---
spring.application.name=ecommerce-core

# --- Database Configuration ---
spring.datasource.url=jdbc:postgresql://ecommerce_db:5432/ecommerce_db
spring.datasource.username=postgres
spring.datasource.password=postgres
spring.datasource.driver-class-name=org.postgresql.Driver

# --- JPA / Hibernate (A CORREÇÃO ESTÁ AQUI) ---
# 'update' faz o Hibernate criar tabelas/colunas que faltam automaticamente
spring.jpa.hibernate.ddl-auto=update
spring.jpa.show-sql=true
spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.PostgreSQLDialect
spring.jpa.properties.hibernate.format_sql=true

# --- Upload Configuration ---
spring.servlet.multipart.max-file-size=10MB
spring.servlet.multipart.max-request-size=10MB

# --- Server Port ---
server.port=8080
